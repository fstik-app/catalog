services:
  api:
    container_name: fstik-api
    build: .
    restart: unless-stopped
    env_file:
      - .env
    depends_on:
      mongod:
        condition: service_healthy
      redis:
        condition: service_started
    labels:
      - "traefik.enable=true"
      # HTTP
      - "traefik.http.routers.fstik-api.rule=Host(`api.fstik.app`)"
      - "traefik.http.routers.fstik-api.entrypoints=web"
      - "traefik.http.routers.fstik-api.service=fstik-api-svc"
      # HTTPS
      - "traefik.http.routers.fstik-api-secure.rule=Host(`api.fstik.app`)"
      - "traefik.http.routers.fstik-api-secure.entrypoints=websecure"
      - "traefik.http.routers.fstik-api-secure.service=fstik-api-svc"
      - "traefik.http.routers.fstik-api-secure.tls=true"
      # Service
      - "traefik.http.services.fstik-api-svc.loadbalancer.server.port=4000"
    networks:
      - fstik-network
      - traefik-public

  mongod:
    container_name: fstik-mongodb
    ports:
      - "100.100.212.75:27018:27017"
    image: mongodb/mongodb-community-server:8.2.0-ubi9
    command: mongod --config /etc/mongod.conf --replSet rs0
    restart: unless-stopped
    volumes:
      - ./data/mongodb:/data/db
      - ./config/mongod.conf:/etc/mongod.conf:ro
      - ./config/keyfile:/etc/mongodb/keyfile:ro
    networks:
      - fstik-network
    healthcheck:
      test: mongosh --quiet --eval "db.adminCommand('ping')" || exit 1
      interval: 5s
      timeout: 5s
      retries: 12
      start_period: 10s

  mongod-setup:
    container_name: fstik-mongodb-setup
    image: mongodb/mongodb-community-server:8.2.0-ubi9
    depends_on:
      mongod:
        condition: service_healthy
    command: bash /setup-replica-set.sh
    volumes:
      - ./config/setup-replica-set.sh:/setup-replica-set.sh:ro
    networks:
      - fstik-network
    restart: "no"
    profiles:
      - setup

  mongot:
    container_name: fstik-mongot
    image: mongodb/mongodb-community-search:0.53.1
    restart: unless-stopped
    volumes:
      - ./data/mongot:/data/mongot
      - ./config/mongot.conf:/mongot-community/config.default.yml:ro
      - ./config/pwfile:/mongot-community/pwfile:ro
    depends_on:
      mongod:
        condition: service_healthy
    networks:
      - fstik-network

  redis:
    container_name: fstik-redis
    image: redis:8-alpine
    restart: unless-stopped
    volumes:
      - ./data/redis:/data
    command: redis-server --appendonly yes
    networks:
      - fstik-network

  backup:
    container_name: fstik-backup
    image: mongo:8
    volumes:
      - ./dump:/dump
    command: mongodump --uri="${ATLAS_MONGODB_URI}" --out=/dump
    networks:
      - fstik-network
    profiles:
      - backup

  restore:
    container_name: fstik-restore
    image: mongo:8
    depends_on:
      mongod:
        condition: service_healthy
    volumes:
      - ./dump:/dump
    command: >
      mongorestore
      --host=mongod
      --username=admin
      --password=adminPassword
      --authenticationDatabase=admin
      --db=fstik
      /dump/fStikBot
    networks:
      - fstik-network
    profiles:
      - restore

networks:
  fstik-network:
    name: fstik-network
  traefik-public:
    external: true
